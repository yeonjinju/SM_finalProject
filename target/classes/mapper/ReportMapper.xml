<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.smhrd.web.report.ReportMapper">

    <!-- 일별 통계 -->
    <select id="getDailyTotalDetectionCount" resultType="java.lang.Integer">
        SELECT COUNT(*) 
        FROM QC_CLASSIFICATION 
        WHERE GH_IDX IN (
            SELECT GH_IDX FROM QC_GREENHOUSE WHERE FARM_IDX = #{farmIdx}
        )
        AND TO_CHAR(CREATED_AT, 'YYYY-MM-DD') = #{date}
    </select>

    <select id="getDailyInsectTypeCount" resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT ANLS_RESULT)
        FROM QC_CLASSIFICATION 
        WHERE GH_IDX IN (
            SELECT GH_IDX FROM QC_GREENHOUSE WHERE FARM_IDX = #{farmIdx}
        )
        AND TO_CHAR(CREATED_AT, 'YYYY-MM-DD') = #{date}
    </select>

    <select id="getDailyTopDetectionZone" resultType="java.lang.String">
        SELECT topZone FROM (
            SELECT G.GH_NAME || ' (' || COUNT(*) || '건)' AS topZone, COUNT(*) AS cnt
            FROM QC_CLASSIFICATION C
            JOIN QC_GREENHOUSE G ON C.GH_IDX = G.GH_IDX
            WHERE G.FARM_IDX = #{farmIdx}
            AND TO_CHAR(C.CREATED_AT, 'YYYY-MM-DD') = #{date}
            GROUP BY G.GH_NAME
            ORDER BY cnt DESC
        ) WHERE ROWNUM = 1
    </select>

    <select id="getDailyHourlyDetectionStats" resultType="com.smhrd.web.report.dto.TimeCountDTO">
        SELECT 
            TO_CHAR(CREATED_AT, 'HH24') AS hour, 
            COUNT(*) AS count
        FROM QC_CLASSIFICATION 
        WHERE GH_IDX IN (
            SELECT GH_IDX FROM QC_GREENHOUSE WHERE FARM_IDX = #{farmIdx}
        )
        AND TO_CHAR(CREATED_AT, 'YYYY-MM-DD') = #{date}
        GROUP BY TO_CHAR(CREATED_AT, 'HH24')
        ORDER BY hour
    </select>

    <select id="getDailyInsectDistribution" resultType="com.smhrd.web.report.dto.InsectDistributionDTO">
        SELECT 
            ANLS_RESULT AS insect, 
            COUNT(*) AS count
        FROM QC_CLASSIFICATION 
        WHERE GH_IDX IN (
            SELECT GH_IDX FROM QC_GREENHOUSE WHERE FARM_IDX = #{farmIdx}
        )
        AND TO_CHAR(CREATED_AT, 'YYYY-MM-DD') = #{date}
        GROUP BY ANLS_RESULT
    </select>

    <select id="getDailyZoneDetectionCounts" resultType="com.smhrd.web.report.dto.ZoneCountDTO">
        SELECT 
            G.GH_NAME AS zone, 
            COUNT(*) AS count
        FROM QC_CLASSIFICATION C
        JOIN QC_GREENHOUSE G ON C.GH_IDX = G.GH_IDX
        WHERE G.FARM_IDX = #{farmIdx}
        AND TO_CHAR(C.CREATED_AT, 'YYYY-MM-DD') = #{date}
        GROUP BY G.GH_NAME
    </select>

    <select id="getDailyDetectionDetails" resultType="com.smhrd.web.report.dto.DetectionDetailDTO">
        SELECT 
            TO_CHAR(C.CREATED_AT, 'HH24:MI') AS time,
            G.GH_NAME AS greenhouse,
            C.ANLS_RESULT AS insect,
            C.ANLS_ACC AS accuracy
        FROM QC_CLASSIFICATION C
        JOIN QC_GREENHOUSE G ON C.GH_IDX = G.GH_IDX
        WHERE G.FARM_IDX = #{farmIdx}
        AND TO_CHAR(C.CREATED_AT, 'YYYY-MM-DD') = #{date}
        ORDER BY C.CREATED_AT
    </select>

    <!-- 월별 통계 -->

</mapper>
